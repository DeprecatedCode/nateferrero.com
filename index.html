<!doctype html>
<head>
    <title>Nate Ferrero</title>
    <link href='http://fonts.googleapis.com/css?family=Asap:400,700,400italic,700italic' rel='stylesheet' type='text/css' />
    <link href="/style/default.css" type="text/css" rel="stylesheet" />
    <script src="/scripts/showdown.js" type="text/javascript"></script>
    <script src="/scripts/jquery.js" type="text/javascript"></script>
    <script src="/scripts/jquery.history.js" type="text/javascript"></script>
    <script src="/scripts/router.js" type="text/javascript"></script>
    <script>
        var router = new Router();
        var md = new Markdown.Converter();

        var post = function(name) {
            home.load = false;
            $.ajax({
                type: 'GET',
                dataType: 'text',
                url: '/posts/' + name + '.md',
                success: function(data) {
                    data = data.split('\n');
                    var text = '', config = {};
                    for(var i = 0; i < data.length; i++) {
                        var c = data[i];
                        if(c.charAt(0) === '@') {
                            var d = c.substr(1).split(' ');
                            var e = d.shift();
                            config[e] = d.join(' ');
                        } else {
                            text += c + '\n';
                        }
                    }
                    console.log(config);
                    
                    /**
                     * Spotify Track Support
                     */
                    text = text.replace(/spotify:track:\w+/g, '<iframe src="https://embed.spotify.com/?uri=$&"'+
                        ' width="300" height="80" frameborder="0" allowtransparency="true"></iframe>');
                    
                    /**
                     * Render
                     */
                    $('.content').html(md.makeHtml(text));
                    $('.author').html(dateFormat(config.date)+
                        ' &ndash; <a href="/">Nate Ferrero</a>');
                },
                error: function() {
                    $('.content').html('<h1>Page Not Found</h1>'+
                        '<p>You may want to go to the <a href="/">home page</a>.</p>');
                }
            });
        };
        
        var home = {load: true};
        home.show = function() {
            if(!home.load) {
                return;
            }
            if(postIndex[0]) {
                post(postIndex[0].url);
            }
        };

        router.route('/', home.show);
        router.route('/:name', post);
        router.route('/:name/', function(name) {
            router.navigate('/' + name);
        });
        
        function ord(x) {
            var n = x % 100;
            var suff = ["th", "st", "nd", "rd", "th"]; // suff for suffix
            return x + (n<21?(n<4 ? suff[n]:suff[0]): (n%10>4 ? suff[0] : suff[n%10]));
        }
        
        /**
         * Date Format
         */
        function dateFormat(x) {
            x = x.split('-');
            var y = parseInt(x[0]), m = parseInt(x[1]), d = parseInt(x[2]);
            return 'Jan Feb Mar Apr May June July Aug Sept Oct Nov Dec'.split(' ')[m-1] +
                ' ' + ord(d) + ', ' + y;
        }
        
        /**
         * Load Post List
         */
        var postIndex = [];
        $(function() {
            $.ajax({
                type: 'GET',
                dataType: 'text',
                url: '/posts/index.md',
                success: function(data) {
                    data = data.split('\n');
                    var config = {};
                    for(var i = 0; i < data.length; i++) {
                        var c = data[i];
                        if(c.charAt(0) === '@') {
                            var d = c.substr(1).split(' ');
                            var e = d.shift();
                            config[e] = d.join(' ');
                        } else if(c.indexOf(' ') > 0) {
                            var f = c.split(' ');
                            config.url = f.shift();
                            config.title = f.join(' ');
                            config.tags = config.tags ? config.tags.split(' ') : [];
                            postIndex.push(config);
                            config = {};
                        } else {
                            config = {};
                        }
                    }
                    if(home.load) {
                        home.show();
                    }
                }
            });
        
            /**
             * Capture all links
             */
            $('.width').on('click', 'a', function(e) {
                var href = $(this).attr('href');
                if(href.substr(0, 1) === '/') {
                    home.load = true;
                    router.navigate(href);
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
</head>
<body>
    <div class="width">
        <div class="icon-container">
            <a class="icon icon-home" href="/"></a>
            <a class="icon icon-phone" href="/contact"></a>
            <br/>
            <a class="icon icon-star" href="/featured"></a>
            <a class="icon icon-web" href="/links"></a>
            
        </div>
        <div class="content">
            <p>Loading Content</p>
        </div>
        <div class="author">
        </div>
    </div>
</body>